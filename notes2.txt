# add env variables for base connections
RUN source /opt/ros/$ROS_DISTRO/setup.bash
ENV SEGWAY_INTERFACE_ADDRESS=10.66.171.1
ENV SEGWAY_IP_ADDRESS=10.66.171.5
ENV SEGWAY_IP_PORT_NUM=8080
ENV SEGWAY_BASE_PLATFORM=RMP_110
ENV SEGWAY_PLATFORM_NAME=RMP_110

# create a catkin_ws and pull from repos supporting hallway demo
RUN mkdir -p catkin_ws/src
WORKDIR /home/bwilab/catkin_ws

RUN /ros_entrypoint.sh wstool init src https://raw.githubusercontent.com/utexas-bwi/bwi/master/rosinstall/melodic_docker.rosinstall
RUN /ros_entrypoint.sh rosdep update
RUN /ros_entrypoint.sh rosdep install --from-paths src --ignore-src --rosdistro $ROS_DISTRO -y

WORKDIR /home/bwilab/catkin_ws/src/bwi_common
RUN git submodule init
RUN git submodule update

WORKDIR /home/bwilab/catkin_ws/src
RUN git clone --branch ahg2s_map https://github.com/utexas-bwi/ahg_common.git
RUN git clone https://github.com/utexas-bwi/bwi_robofleet.git --recursive
WORKDIR /home/bwilab/catkin_ws
# RUN catkin config --extend /opt/ros/$ROS_DISTRO
RUN /ros_entrypoint.sh catkin build
RUN source devel/setup.bash
source 
WORKDIR /home/bwilab
RUN echo 'source /opt/ros/$ROS_DISTRO/setup.bash' >> /home/bwilab/.bashrc
RUN echo 'source /home/bwilab/catkin_ws/devel/setup.bash' >> /home/bwilab/.bashrc
RUN echo '# some bwi-bot variables \
      export SEGWAY_INTERFACE_ADDRESS=10.66.171.1 \
      export SEGWAY_IP_ADDRESS=10.66.171.5 \
      export SEGWAY_IP_PORT_NUM=8080 \
      export SEGWAY_BASE_PLATFORM=RMP_110 \
      export SEGWAY_PLATFORM_NAME=RMP_110' \
      >> /home/bwilab/.bashrc

USER postgres
RUN  /etc/init.d/postgresql start &&\
    psql -c "ALTER USER postgres WITH PASSWORD 'nopass'" &&\
    createdb knowledge_base &&\
	psql -d knowledge_base -f catkin_ws/src/bwi_common/knowledge_representation/sql/schema_postgresql.sql &&\
	/etc/init.d/postgresql stop

USER bwilab

VOLUME /var/lib/postgresql
VOLUME /home/bwilab
#COPY ./entrypoint.sh /entrypoint.sh
#ENTRYPOINT ["/entrypoint.sh"]

opencv includes cause issues with ros noetic
